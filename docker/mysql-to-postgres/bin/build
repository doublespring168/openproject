#!/bin/bash
set -e
set -o pipefail

cd /opt

echo "111"

# install Clozure CL to avoid memory issues with the standard SBCL
curl -sL https://github.com/Clozure/ccl/releases/download/v1.11.5/ccl-1.11.5-linuxx86.tar.gz -o - | tar xzf - -C /opt/
ln -s /opt/ccl/scripts/ccl64 /usr/local/bin/ccl

export CCL_DEFAULT_DIRECTORY=/opt/ccl

echo "222"
# build pgloader from source using CCL as the lisp runtime
git clone -q https://github.com/dimitri/pgloader.git --branch rel_3_2_stable --depth 1

echo "333"
cd pgloader
make CL=ccl pgloader >& /tmp/pgloader-compile.log || (cat /tmp/pgloader-compile.log && exit 1)
mv /opt/pgloader/build/bin/pgloader /usr/local/bin/pgloader-ccl
echo "444"
rm -rf /opt/pgloader /tmp/pgloader-compile.log /usr/local/bin/ccl /opt/ccl
